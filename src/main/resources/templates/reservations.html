<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>동아리방 예약</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
<h2 th:text="${yearMonth} + ' 타임테이블'"></h2>

<div>
    <a th:href="@{/reservations(year=${yearMonth.minusMonths(1).year}, month=${yearMonth.minusMonths(1).monthValue})}">◀ 이전달</a>
    <a th:href="@{/reservations(year=${yearMonth.plusMonths(1).year}, month=${yearMonth.plusMonths(1).monthValue})}">다음달 ▶</a>
</div>

<hr>

<!-- 달력 -->
<table>
    <thead>
    <tr>
        <th>시간</th>
        <th>일</th><th>월</th><th>화</th><th>수</th><th>목</th><th>금</th><th>토</th>
    </tr>
    </thead>

    <tbody>

    <tr th:each="week : ${weeks}">
        <td>
            <div class="day-cell">

                <!-- 05:00 ~ 24:00 슬롯 -->
                <div class="slots">
                    <!-- h = 5..23 (각 슬롯은 h:00 ~ (h+1):00 구간) -->
                    <div class="day-header" ></div>
                    <div class="slot-row"
                         th:each="h : ${#numbers.sequence(5,23)}">
                        <!-- 시간 구간 표시 -->
                        <div class="slot-time"
                             th:text="${T(java.lang.String).format('%02d:00~%02d:00', h, h+1)}">
                        </div>
                    </div>
                </div>
            </div>
        </td>

        <td th:each="day : ${week}"
            th:classappend="${day.monthValue != yearMonth.monthValue} ? 'other-month'">

            <div class="day-cell">
                <!-- 날짜 헤더 -->
                <div class="day-header" th:text="${day.dayOfMonth}"></div>

                <!-- 05:00 ~ 24:00 슬롯 -->
                <div class="slots">
                    <!-- h = 5..23 (각 슬롯은 h:00 ~ (h+1):00 구간) -->
                    <div class="slot-row"
                         th:each="h : ${#numbers.sequence(5,23)}"
                         th:with="dateKey=${#temporals.format(day, 'yyyy-MM-dd')},
                         slotList=${reservationMap[dateKey.toString()] != null ? reservationMap[dateKey.toString()][h.toString()] : null}">

                        <!-- 시간 구간 표시 -->
                        <div class="slot-time"
                             th:text="${T(java.lang.String).format('%02d:00~%02d:00', h, h+1)}">
                        </div>

                        <div class="slot-body">
                            <!-- 예약 있음: 예약자명 표시 -->
                            <span th:if="${!#lists.isEmpty(slotList)}"
                                  class="tag"
                                  th:text="${slotList.get(0).reserver}"></span>

                            <!-- 예약 없음: 입력칸 -->
                            <input type="text"
                                   th:if="${#lists.isEmpty(slotList)}"
                                   class="slot-input"
                                   th:data-date="${dateKey}"
                                   th:data-hour="${hourKey}"
                                   th:value="${!#lists.isEmpty(slotList) ? slotList.get(0).reserver : ''}"
                                   placeholder="예약자 입력"/>
                        </div>
                    </div>
                </div>
            </div>
        </td>
    </tr>
    </tbody>
</table>
<script>
    document.addEventListener("DOMContentLoaded", () => {
        document.querySelectorAll(".slot-input").forEach(input => {
            input.addEventListener("keydown", e => {
                if (e.key === "Enter") {
                    e.preventDefault();
                    saveReservation(input);
                }
            });
            input.addEventListener("blur", () => {
                if (input.value.trim() !== "") {
                    saveReservation(input);
                }
            });
        });

        function saveReservation(input) {
            const reserver = input.value.trim();
            const date = input.dataset.date;
            const hour = input.dataset.hour;

            if (!reserver) return;

            fetch("/reservations/inline", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    date: date,
                    startTime: (hour.length === 1 ? "0" + hour : hour) + ":00",
                    endTime: (parseInt(hour) + 1) + ":00",
                    reserver: reserver
                })
            }).then(res => {
                if (res.ok) {
                    location.reload();  // ✅ DB 저장 후 화면 다시 불러오기
                } else {
                    alert("저장 실패!");
                }
            });
        }
    });
</script>
</body>
</html>



