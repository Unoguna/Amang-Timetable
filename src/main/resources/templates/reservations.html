<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>동아리방 예약</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
<h2 th:text="${yearMonth} + ' 타임테이블'"></h2>

<div>
    <a th:href="@{/reservations(year=${yearMonth.minusMonths(1).year}, month=${yearMonth.minusMonths(1).monthValue})}">◀ 이전달</a>
    <a th:href="@{/reservations(year=${yearMonth.plusMonths(1).year}, month=${yearMonth.plusMonths(1).monthValue})}">다음달 ▶</a>
</div>

<hr>

<!-- 달력 -->
<table>
    <thead>
    <tr>
        <th>시간</th>
        <th>일</th><th>월</th><th>화</th><th>수</th><th>목</th><th>금</th><th>토</th>
    </tr>
    </thead>

    <tbody>

    <tr th:each="week : ${weeks}">
        <td>
            <div class="day-cell">

                <!-- 05:00 ~ 24:00 슬롯 -->
                <div class="slots">
                    <!-- h = 5..23 (각 슬롯은 h:00 ~ (h+1):00 구간) -->
                    <div class="time-header" ></div>
                    <div class="slot-row"
                         th:each="h : ${#numbers.sequence(5,23)}">
                        <!-- 시간 구간 표시 -->
                        <div class="slot-time"
                             th:text="${T(java.lang.String).format('%02d:00~%02d:00', h, h+1)}">
                        </div>
                    </div>
                </div>
            </div>
        </td>

        <td th:each="day : ${week}"
            th:classappend="${day.monthValue != yearMonth.monthValue} ? 'other-month'">

            <div class="day-cell">
                <!-- 날짜 헤더 -->
                <div class="day-header" th:text="${day.dayOfMonth}"></div>

                <!-- 05:00 ~ 24:00 슬롯 -->
                <div class="slots">
                    <!-- h = 5..23 (각 슬롯은 h:00 ~ (h+1):00 구간) -->
                    <div class="slot-row"
                         th:each="h : ${#numbers.sequence(5,23)}"
                         th:with="dateKey=${#temporals.format(day, 'yyyy-MM-dd')},
                         slotList=${reservationMap[dateKey.toString()] != null ? reservationMap[dateKey.toString()][h.toString()] : null}">


                        <div class="slot-body">
                            <!-- 예약 없음: 입력칸 -->
                            <input type="text"
                                   class="slot-input"
                                   th:data-date="${dateKey}"
                                   th:data-hour="${h}"
                                   th:value="${!#lists.isEmpty(slotList) ? slotList.get(0).reserver : ''}"
                            />
                        </div>
                    </div>
                </div>
            </div>
        </td>
    </tr>
    </tbody>
</table>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>
<script>

    let stompClient = null;
    let wsReady = false;
    const socketId = Math.random().toString(36).substring(2, 9); // ✅ 내 브라우저 고유 ID

    document.addEventListener("DOMContentLoaded", () => {
        connectWebSocket();
        /*
            사용자가 칸에 이름을 입력하고 엔터를 누르거나, 입력 후 포커스를 벗어나면(blur)
            → saveReservation(input) 실행됨.
        */
        document.querySelectorAll(".slot-input").forEach(input => {

            // 🔹 타이핑할 때마다 상대방 화면에도 바로 반영 (DB는 저장 안 함)
            input.addEventListener("input", () => {
                sendReservation(input, false);
            });


            input.addEventListener("keydown", e => {
                if (e.key === "Enter") {
                    e.preventDefault();
                    sendReservation(input, true); // 최종 저장
                    input.blur();               // ✅ 엔터 후 포커스 해제
                }
            });

            input.addEventListener("blur", () => {
                sendReservation(input, true); // 포커스 빠질 때 저장
            });
        });
    });

    function connectWebSocket() {
        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);

        stompClient.connect({}, () => {
            wsReady = true;
            console.log("✅ WebSocket 연결됨");

            // 서버가 브로드캐스트하는 업데이트 구독
            stompClient.subscribe('/topic/calendar', (res) => {
                const update = JSON.parse(res.body);
                applyUpdate(update);
            });
        }, (err) => {
            console.error('WS connect error:', err);
        });
    }

    function sendReservation(input, persist) {
        if (!wsReady) {
            console.warn("WS not ready; message skipped", input);
            return;
        }

        const reserver = input.value;
        const date = input.dataset.date;
        const hour = parseInt(input.dataset.hour, 10);
        const startTime = String(hour).padStart(2, "0") + ":00";
        const endTime = (hour === 23)
            ? "23:59"
            : String(hour + 1).padStart(2, "0") + ":00";

        const message = { date, startTime, endTime, reserver, persist, sender: socketId  };
        stompClient.send("/app/updateCell", {}, JSON.stringify(message));
    }

    // ✅ 받은 업데이트를 data-date + data-start 로 정확히 찾아서 반영
    function applyUpdate(update) {
        // ✅ 내가 보낸 메시지는 무시
        if (update.sender === socketId) return;

        console.log("📩 받은 업데이트:", update);
        const selector = `.slot-input[data-date="${update.date}"][data-hour="${parseInt(update.startTime)}"]`;
        const input = document.querySelector(selector);
        if (input) input.value = update.reserver;
    }
</script>
</body>
</html>



