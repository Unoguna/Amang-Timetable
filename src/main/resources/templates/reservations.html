<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ë™ì•„ë¦¬ë°© ì˜ˆì•½</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
<h2 th:text="${yearMonth} + ' íƒ€ì„í…Œì´ë¸”'"></h2>

<div>
    <a th:href="@{/reservations(year=${yearMonth.minusMonths(1).year}, month=${yearMonth.minusMonths(1).monthValue})}">â—€ ì´ì „ë‹¬</a>
    <a th:href="@{/reservations(year=${yearMonth.plusMonths(1).year}, month=${yearMonth.plusMonths(1).monthValue})}">ë‹¤ìŒë‹¬ â–¶</a>
</div>

<hr>

<!-- ë‹¬ë ¥ -->
<table>
    <thead>
    <tr>
        <th>ì‹œê°„</th>
        <th>ì¼</th><th>ì›”</th><th>í™”</th><th>ìˆ˜</th><th>ëª©</th><th>ê¸ˆ</th><th>í† </th>
    </tr>
    </thead>

    <tbody>

    <tr th:each="week : ${weeks}">
        <td>
            <div class="day-cell">

                <!-- 05:00 ~ 24:00 ìŠ¬ë¡¯ -->
                <div class="slots">
                    <!-- h = 5..23 (ê° ìŠ¬ë¡¯ì€ h:00 ~ (h+1):00 êµ¬ê°„) -->
                    <div class="time-header" ></div>
                    <div class="slot-row"
                         th:each="h : ${#numbers.sequence(5,23)}">
                        <!-- ì‹œê°„ êµ¬ê°„ í‘œì‹œ -->
                        <div class="slot-time"
                             th:text="${T(java.lang.String).format('%02d:00~%02d:00', h, h+1)}">
                        </div>
                    </div>
                </div>
            </div>
        </td>

        <td th:each="day : ${week}"
            th:classappend="${day.monthValue != yearMonth.monthValue} ? 'other-month'">

            <div class="day-cell">
                <!-- ë‚ ì§œ í—¤ë” -->
                <div class="day-header" th:text="${day.dayOfMonth}"></div>

                <!-- 05:00 ~ 24:00 ìŠ¬ë¡¯ -->
                <div class="slots">
                    <!-- h = 5..23 (ê° ìŠ¬ë¡¯ì€ h:00 ~ (h+1):00 êµ¬ê°„) -->
                    <div class="slot-row"
                         th:each="h : ${#numbers.sequence(5,23)}"
                         th:with="dateKey=${#temporals.format(day, 'yyyy-MM-dd')},
                         slotList=${reservationMap[dateKey.toString()] != null ? reservationMap[dateKey.toString()][h.toString()] : null}">


                        <div class="slot-body">
                            <!-- ì˜ˆì•½ ì—†ìŒ: ì…ë ¥ì¹¸ -->
                            <input type="text"
                                   class="slot-input"
                                   th:data-date="${dateKey}"
                                   th:data-hour="${h}"
                                   th:value="${!#lists.isEmpty(slotList) ? slotList.get(0).reserver : ''}"
                            />
                        </div>
                    </div>
                </div>
            </div>
        </td>
    </tr>
    </tbody>
</table>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>
<script>

    let stompClient = null;
    let wsReady = false;
    const socketId = Math.random().toString(36).substring(2, 9); // âœ… ë‚´ ë¸Œë¼ìš°ì € ê³ ìœ  ID

    document.addEventListener("DOMContentLoaded", () => {
        connectWebSocket();
        /*
            ì‚¬ìš©ìê°€ ì¹¸ì— ì´ë¦„ì„ ì…ë ¥í•˜ê³  ì—”í„°ë¥¼ ëˆ„ë¥´ê±°ë‚˜, ì…ë ¥ í›„ í¬ì»¤ìŠ¤ë¥¼ ë²—ì–´ë‚˜ë©´(blur)
            â†’ saveReservation(input) ì‹¤í–‰ë¨.
        */
        document.querySelectorAll(".slot-input").forEach(input => {

            // ğŸ”¹ íƒ€ì´í•‘í•  ë•Œë§ˆë‹¤ ìƒëŒ€ë°© í™”ë©´ì—ë„ ë°”ë¡œ ë°˜ì˜ (DBëŠ” ì €ì¥ ì•ˆ í•¨)
            input.addEventListener("input", () => {
                sendReservation(input, false);
            });


            input.addEventListener("keydown", e => {
                if (e.key === "Enter") {
                    e.preventDefault();
                    sendReservation(input, true); // ìµœì¢… ì €ì¥
                    input.blur();               // âœ… ì—”í„° í›„ í¬ì»¤ìŠ¤ í•´ì œ
                }
            });

            input.addEventListener("blur", () => {
                sendReservation(input, true); // í¬ì»¤ìŠ¤ ë¹ ì§ˆ ë•Œ ì €ì¥
            });
        });
    });

    function connectWebSocket() {
        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);

        stompClient.connect({}, () => {
            wsReady = true;
            console.log("âœ… WebSocket ì—°ê²°ë¨");

            // ì„œë²„ê°€ ë¸Œë¡œë“œìºìŠ¤íŠ¸í•˜ëŠ” ì—…ë°ì´íŠ¸ êµ¬ë…
            stompClient.subscribe('/topic/calendar', (res) => {
                const update = JSON.parse(res.body);
                applyUpdate(update);
            });
        }, (err) => {
            console.error('WS connect error:', err);
        });
    }

    function sendReservation(input, persist) {
        if (!wsReady) {
            console.warn("WS not ready; message skipped", input);
            return;
        }

        const reserver = input.value;
        const date = input.dataset.date;
        const hour = parseInt(input.dataset.hour, 10);
        const startTime = String(hour).padStart(2, "0") + ":00";
        const endTime = (hour === 23)
            ? "23:59"
            : String(hour + 1).padStart(2, "0") + ":00";

        const message = { date, startTime, endTime, reserver, persist, sender: socketId  };
        stompClient.send("/app/updateCell", {}, JSON.stringify(message));
    }

    // âœ… ë°›ì€ ì—…ë°ì´íŠ¸ë¥¼ data-date + data-start ë¡œ ì •í™•íˆ ì°¾ì•„ì„œ ë°˜ì˜
    function applyUpdate(update) {
        // âœ… ë‚´ê°€ ë³´ë‚¸ ë©”ì‹œì§€ëŠ” ë¬´ì‹œ
        if (update.sender === socketId) return;

        console.log("ğŸ“© ë°›ì€ ì—…ë°ì´íŠ¸:", update);
        const selector = `.slot-input[data-date="${update.date}"][data-hour="${parseInt(update.startTime)}"]`;
        const input = document.querySelector(selector);
        if (input) input.value = update.reserver;
    }
</script>
</body>
</html>



